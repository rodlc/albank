<div class="container mt-4 mt-md-5" data-controller="clipboard">
  <div class="mb-3 mb-md-4 d-print-none">
    <%= link_to statement_path(@statement, active_tab: @opportunity.result_type), class: "text-decoration-none text-muted small fw-semibold" do %>
      <span class="me-1" aria-hidden="true">â†</span> Retour au relevÃ©
    <% end %>
  </div>

  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <!-- Stepper responsive -->
      <div class="opportunity-stepper d-print-none mb-4">
        <div class="stepper-track"></div>
        <div class="stepper-progress" style="width: <%= @opportunity.completed? ? '100%' : (@opportunity.contacted? ? '50%' : '0%') %>;"></div>

        <div class="stepper-steps">
          <!-- Step 1 -->
          <div class="stepper-step active">
            <div class="stepper-circle bg-primary text-white">
              <span aria-hidden="true">ğŸ•µï¸</span>
            </div>
            <span class="stepper-label">DÃ©tectÃ©e</span>
          </div>

          <!-- Step 2 -->
          <div class="stepper-step <%= @opportunity.contacted? || @opportunity.completed? ? 'active' : '' %>">
            <div class="stepper-circle <%= @opportunity.contacted? || @opportunity.completed? ? 'bg-primary text-white' : 'bg-white border' %>">
              <span aria-hidden="true">âœ‰ï¸</span>
            </div>
            <span class="stepper-label">ContactÃ©e</span>
          </div>

          <!-- Step 3 -->
          <div class="stepper-step <%= @opportunity.completed? ? 'active' : '' %>">
            <div class="stepper-circle <%= @opportunity.completed? ? 'bg-primary text-white' : 'bg-white border' %>">
              <span aria-hidden="true">ğŸ‰</span>
            </div>
            <span class="stepper-label">ClÃ´turÃ©e</span>
          </div>
        </div>
      </div>

      <!-- Intro lettre -->
      <div class="text-center mb-4 d-print-none">
        <h2 class="h4 h3-md fw-bold mb-2">ModÃ¨le de lettre prÃªt Ã  l'emploi</h2>
        <p class="text-muted mb-4">
          Utilisez ce modÃ¨le pour nÃ©gocier avec votre fournisseur
        </p>

        <!-- Actions groupÃ©es -->
        <div class="opportunity-actions">
          <button
            type="button"
            class="btn btn-primary"
            data-clipboard-target="button"
            data-action="click->clipboard#copy"
          >
            <span aria-hidden="true">ğŸ“‹</span> Copier la lettre
          </button>

          <button
            type="button"
            class="btn btn-outline-primary"
            onclick="window.print()"
          >
            <span aria-hidden="true">ğŸ–¨ï¸</span> Imprimer
          </button>

          <%= form_with(model: [@statement, @expense, @opportunity], method: :patch, local: true, class: "d-flex gap-2 justify-content-center flex-wrap") do %>
            <% unless @opportunity.contacted? || @opportunity.completed? %>
              <button
                type="submit"
                name="opportunity[status]"
                value="contacted"
                class="btn btn-gov-primary"
              >
                <span aria-hidden="true">âœ‰ï¸</span> Envoyer
              </button>
            <% end %>

            <% if @opportunity.contacted? && !@opportunity.completed? %>
              <button
                type="submit"
                name="opportunity[status]"
                value="completed"
                class="btn btn-success"
              >
                <span aria-hidden="true">âœ…</span> ClÃ´turer
              </button>
            <% end %>

            <% if @opportunity.completed? %>
              <button
                type="submit"
                name="opportunity[status]"
                value="pending"
                class="btn btn-soft"
              >
                <span aria-hidden="true">â†©ï¸</span> Restaurer
              </button>
            <% end %>
          <% end %>
        </div>

        <!-- Feedback copie -->
        <div
          data-clipboard-target="feedback"
          class="alert alert-success text-center d-none border-0 mt-3"
          role="alert"
        >
          <span aria-hidden="true">âœ…</span> Texte copiÃ© dans le presse-papiers !
        </div>
      </div>

      <%= render 'negotiation_letter' %>
    </div>
  </div>
</div>
