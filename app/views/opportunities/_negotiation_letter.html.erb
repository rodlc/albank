<div class="letter-preview" data-controller="clipboard">
  <!-- Overlay au hover -->
  <div class="letter-overlay d-print-none">
    <div class="d-flex flex-column gap-3 align-items-center">
      <button
        type="button"
        class="btn btn-outline-light rounded-pill px-4 py-2 fw-semibold"
        data-clipboard-target="button"
        data-action="click->clipboard#copy"
      >
        <span class="me-2">üìã</span> Copier
      </button>

      <button
        type="button"
        class="btn btn-outline-light rounded-pill px-4 py-2 fw-semibold"
        onclick="window.print()"
      >
        <span class="me-2">üñ®Ô∏è</span> Imprimer
      </button>

      <%= form_with(model: [@statement, @expense, @opportunity], method: :patch, local: true, class: "w-100 d-flex justify-content-center") do |f| %>
        <% unless @opportunity.contacted? || @opportunity.completed? %>
          <%= f.button name: "opportunity[status]", value: "contacted", class: "btn btn-primary fw-bold px-5 py-3 rounded-pill shadow-lg" do %>
            <span class="me-2">‚úÖ</span> J'ai envoy√© la lettre
          <% end %>
        <% end %>

        <% if @opportunity.contacted? && !@opportunity.completed? %>
          <%= f.button name: "opportunity[status]", value: "completed", class: "btn btn-success fw-bold px-5 py-3 rounded-pill shadow-lg" do %>
            <span class="me-2">üéâ</span> Je confirme l'√©conomie
          <% end %>
        <% end %>

        <% if @opportunity.completed? %>
          <div class="text-white fw-bold bg-success px-4 py-2 rounded-pill">
            <span class="me-2">üéâ</span> Dossier cl√¥tur√©
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Feedback copie -->
    <div
      data-clipboard-target="feedback"
      class="
        alert alert-success text-center d-none border-0 fw-bold rounded-pill
        mt-3 position-absolute
      "
      style="top: 1rem; left: 50%; transform: translateX(-50%); min-width: 200px;"
      role="alert"
    >
      <span class="me-2">‚úÖ</span> Copi√©!
    </div>
  </div>

  <!-- Lettre -->
  <div class="action-section pt-0">
    <div class="container">
      <div
        class="paper-sheet shadow-lg position-relative"
        id="letter-content"
        data-clipboard-target="source"
        style="border: none;"
      >
        <!-- Letter Header -->
        <div class="d-flex justify-content-between mb-5">
          <div class="text-muted small fst-italic">
            [Vos Coordonn√©es]
          </div>

          <div class="fw-bold">
            Le <%= l(Date.current, format: "%d %B %Y") %>
          </div>
        </div>

        <div class="mb-5">
          <p class="fw-bold mb-4">
            Objet: Demande d'alignement tarifaire - Contrat
            <span class="bg-warning bg-opacity-25 px-1"><%= @opportunity.expense.category.name %></span>
          </p>

          <p>Madame, Monsieur,</p>

          <p>
            Titulaire d'un contrat aupr√®s de votre √©tablissement, je viens par
            la pr√©sente solliciter une r√©vision de mes conditions tarifaires.
          </p>

          <p>
            Une analyse comparative de mes charges, effectu√©e ce jour, a mis en
            √©vidence un d√©calage significatif entre ma tarification actuelle et
            la r√©alit√© du march√© :
          </p>

          <div class="my-4 ps-3 border-start border-3 border-primary bg-light p-3">
            <ul class="list-unstyled mb-0">
              <li class="mb-2">
                Mon tarif actuel:
                <strong><%= number_to_currency(@opportunity.expense.subtotal, unit: "‚Ç¨", precision: 2) %></strong>
                / <%= @opportunity.standard.unit %>
              </li>

              <li class="mb-2">
                Moyenne du march√©:
                <strong><%= number_to_currency(@opportunity.standard.average_amount, unit: "‚Ç¨", precision: 2) %></strong>
                / <%= @opportunity.standard.unit %>
              </li>

              <li class="text-danger fw-bold">
                √âcart constat√©:
                +<%= ((@opportunity.savings / @opportunity.expense.subtotal) * 100).round %>%
              </li>
            </ul>
          </div>

          <p>
            Client fid√®le, je privil√©gie la continuit√© de nos relations.
            Toutefois, cet √©cart n'est plus justifi√© au regard des offres
            concurrentes √† garanties √©quivalentes.
          </p>

          <p>
            Je vous invite donc √† me faire parvenir une proposition commerciale
            rectificative sous 10 jours. √Ä d√©faut d'un alignement concurrentiel
            de votre part, je me verrais contraint de proc√©der √† la r√©siliation
            de ce contrat conform√©ment √† la l√©gislation en vigueur.
          </p>

          <p class="mt-5">
            Dans cette attente, je vous prie d'agr√©er, Madame, Monsieur, mes
            salutations distingu√©es.
          </p>

          <div class="mt-5 pt-5 border-top w-25">
            <small class="text-muted">[Votre Signature]</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
