<div class="action-section pt-0" data-controller="clipboard">
  <div class="container">
    <div
      class="paper-sheet shadow-lg position-relative"
      id="letter-content"
      data-clipboard-target="source"
      style="border: none;"
    >
      <!-- Letter Header -->
      <div class="d-flex justify-content-between mb-5">
        <div class="text-muted small fst-italic">
          [Vos Coordonnées]
        </div>

        <div class="fw-bold">Le <%= l(Date.current, format: "%d %B %Y") %></div>
      </div>

      <div class="mb-5">
        <p class="fw-bold mb-4">
          Objet: Demande d'alignement tarifaire - Contrat
          <span class="bg-warning bg-opacity-25 px-1"><%= @opportunity.expense.category.name %></span>
        </p>

        <p>Madame, Monsieur,</p>

        <p>
          Titulaire d'un contrat auprès de votre établissement, je viens par la
          présente solliciter une révision de mes conditions tarifaires.
        </p>

        <p>
          Une analyse comparative de mes charges, effectuée ce jour, a mis en
          évidence un décalage significatif entre ma tarification actuelle et la
          réalité du marché :
        </p>

        <div class="my-4 ps-3 border-start border-3 border-primary bg-light p-3">
          <ul class="list-unstyled mb-0">
            <li class="mb-2">
              Mon tarif actuel:
              <strong><%= number_to_currency(@opportunity.expense.subtotal, unit: "€", precision: 2) %></strong>
              / <%= @opportunity.standard.unit %>
            </li>

            <li class="mb-2">
              Moyenne du marché:
              <strong><%= number_to_currency(@opportunity.standard.average_amount, unit: "€", precision: 2) %></strong>
              / <%= @opportunity.standard.unit %>
            </li>

            <li class="text-danger fw-bold">
              Écart constaté:
              +<%= ((@opportunity.savings / @opportunity.expense.subtotal) * 100).round %>%
            </li>
          </ul>
        </div>

        <p>
          Client fidèle, je privilégie la continuité de nos relations.
          Toutefois, cet écart n'est plus justifié au regard des offres
          concurrentes à garanties équivalentes.
        </p>

        <p>
          Je vous invite donc à me faire parvenir une proposition commerciale
          rectificative sous 10 jours. À défaut d'un alignement concurrentiel de
          votre part, je me verrais contraint de procéder à la résiliation de ce
          contrat conformément à la législation en vigueur.
        </p>

        <p class="mt-5">
          Dans cette attente, je vous prie d'agréer, Madame, Monsieur, mes
          salutations distinguées.
        </p>

        <div class="mt-5 pt-5 border-top w-25">
          <small class="text-muted">[Votre Signature]</small>
        </div>
      </div>
    </div>

    <!-- Boutons d'action flottants -->
    <div class="letter-actions sticky-bottom pb-4 pt-3 bg-white border-top mt-0">
      <div class="d-flex gap-3 justify-content-center">
        <button
          type="button"
          class="btn btn-outline-dark rounded-pill px-4 fw-bold"
          data-clipboard-target="button"
          data-action="click->clipboard#copy"
        >
          <i class="far fa-copy me-2"></i>
          Copier le texte
        </button>

        <button
          type="button"
          class="btn btn-primary rounded-pill px-4 fw-bold"
          onclick="window.print()"
        >
          <i class="fas fa-print me-2"></i>
          Imprimer la lettre
        </button>
      </div>
    </div>

    <div
      data-clipboard-target="feedback"
      class="alert alert-success mt-3 text-center d-none"
      role="alert"
    >
      <span class="me-2">✅</span> Lettre copiée dans le presse-papiers!
    </div>
  </div>
</div>
