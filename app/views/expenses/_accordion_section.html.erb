<%
  config = result_type_config(result_type)
  section_id = "section-#{result_type}-#{index}"
  
  is_active = if params[:active_tab].present?
                params[:active_tab].to_s == result_type.to_s
              else
                index == 0
              end

  show_class = is_active ? "show" : ""
  totals = section_totals(expenses)
%>

<div class="accordion-item accordion-<%= config[:color] %>">
  <h2 class="accordion-header">
    <button
      class="accordion-button <%= 'collapsed' unless is_active %>"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#<%= section_id %>"
      aria-expanded="<%= is_active ? 'true' : 'false' %>"
      aria-controls="<%= section_id %>"
      aria-label="<%= config[:label] %> : <%= expenses.count %> dépense(s), total <%= number_to_currency(totals[:total], unit: '€', precision: 0, separator: ',', delimiter: ' ') %><%= ", économies potentielles #{number_to_currency(totals[:savings], unit: '€', precision: 0, separator: ',', delimiter: ' ')}" if totals[:savings] > 0 %>"
    >
      <div class="d-flex align-items-center gap-2 flex-grow-1">
        <span class="section-emoji"><%= config[:emoji] %></span>
        <span class="section-label"><%= config[:label] %></span>
        <span class="badge badge-<%= config[:color] %>"><%= expenses.count %></span>
      </div>
      <!-- Desktop Alignment Wrapper -->
      <div class="d-none d-md-flex align-items-center gap-4 ms-auto">
        <div class="fw-bold text-end" style="min-width: 100px;">
          <%= number_to_currency(totals[:total], unit: "€", precision: 0, separator: ",", delimiter: " ") %>
        </div>

        <% if result_type == :opportunity && totals[:savings] > 0 %>
          <div class="text-primary fw-bold text-end text-nowrap" style="min-width: 100px;">
            <i class="fas fa-caret-up me-1"></i><%= number_to_currency(totals[:savings], unit: "€", precision: 0, separator: ",", delimiter: " ") %>
          </div>
        <% elsif result_type == :success && totals[:savings] < 0 %>
          <div class="text-success fw-bold text-end text-nowrap" style="min-width: 100px;">
            <i class="fas fa-caret-down me-1"></i><%= number_to_currency(totals[:savings].abs, unit: "€", precision: 0, separator: ",", delimiter: " ") %>
          </div>
        <% elsif result_type == :danger %>
          <div class="text-danger fw-bold text-end text-nowrap" style="min-width: 100px;">
            <i class="fas fa-caret-up small me-1"></i><%= number_to_currency(totals[:total], unit: "€", precision: 0, separator: ",", delimiter: " ") %>
          </div>
        <% else %>
          <div style="min-width: 100px;"></div>
        <% end %>

        <div class="d-flex align-items-center justify-content-center gap-2" style="width: 140px;">
          <%= result_type == :opportunity ? 'Contacter' : 'Voir' %> <i class="fas fa-chevron-down transition-transform"></i>
        </div>
      </div>

      <!-- Mobile Totals (Simplified) -->
      <div class="d-md-none ms-auto d-flex flex-column align-items-end">
        <span class="fw-bold">
          <%= number_to_currency(totals[:total], unit: "€", precision: 0, separator: ",", delimiter: " ") %>
        </span>
        <% if result_type == :opportunity && totals[:savings] > 0 %>
          <span class="text-primary fw-bold small">
            <i class="fas fa-caret-up me-1"></i><%= number_to_currency(totals[:savings], unit: "€", precision: 0, separator: ",", delimiter: " ") %>
          </span>
        <% elsif result_type == :success && totals[:savings] < 0 %>
          <span class="text-success fw-bold small">
            <i class="fas fa-caret-down me-1"></i><%= number_to_currency(totals[:savings].abs, unit: "€", precision: 0, separator: ",", delimiter: " ") %>
          </span>
        <% elsif result_type == :danger %>
          <span class="text-danger fw-bold small">
            <i class="fas fa-caret-up small me-1"></i><%= number_to_currency(totals[:total], unit: "€", precision: 0, separator: ",", delimiter: " ") %>
          </span>
        <% end %>
      </div>
    </button>
  </h2>

  <div
    id="<%= section_id %>"
    class="accordion-collapse collapse <%= show_class %>"
    data-bs-parent="#expensesAccordion"
  >
    <div class="accordion-body">
      <% group_expenses(expenses).each do |expense| %>
        <%= render "expenses/expense_row", expense: expense, statement: statement %>
      <% end %>
    </div>
  </div>
</div>
