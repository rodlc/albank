<% opportunity = expense.opportunities.first %>

<div class="expense-row py-3 border-bottom">
  <div class="row g-2 align-items-center">
    
    <!-- 1. Icon & Category & Amount (Mobile Header) -->
    <div class="col-12 col-md-4 d-flex align-items-center justify-content-between justify-content-md-start">
      <div class="d-flex align-items-center gap-2 overflow-hidden">
        <div class="expense-icon flex-shrink-0">
          <%= category_emoji(expense.category) %>
        </div>
        <div class="expense-category fw-bold text-truncate">
          <%= expense.category.name %>
        </div>
      </div>
      
      <!-- Mobile Amount -->
      <div class="d-md-none fw-bold">
        <%= number_to_currency(expense.subtotal, unit: "€", precision: 2, separator: ",", delimiter: " ") %>
      </div>
    </div>

    <!-- 2. Label (Truncated) -->
    <div class="col-12 col-md-4">
      <div class="text-muted small text-truncate" title="<%= expense.label %>">
        <%= expense.label %>
        <% if expense.respond_to?(:grouped?) && expense.grouped? %>
          <span class="badge bg-secondary ms-1">×<%= expense.grouped_expenses.size %></span>
        <% end %>
      </div>
    </div>

    <!-- 3. Desktop Amount & Savings & Button -->
    <div class="col-12 col-md-4 d-flex align-items-center justify-content-between justify-content-md-end gap-3">
      
      <!-- Desktop Amount -->
      <div class="d-none d-md-block fw-bold text-end" style="min-width: 80px;">
        <%= number_to_currency(expense.subtotal, unit: "€", precision: 2, separator: ",", delimiter: " ") %>
      </div>

      <!-- Savings -->
      <% if opportunity&.opportunity? && opportunity.savings > 0 %>
        <div class="text-primary fw-bold text-nowrap">
          <i class="fas fa-arrow-down small me-1"></i><%= number_to_currency(opportunity.savings, unit: "€", precision: 0, separator: ",", delimiter: " ") %>
        </div>
      <% end %>

      <!-- Action Button -->
      <div class="flex-shrink-0">
        <%= render "opportunities/action_button",
                   expense: expense,
                   opportunity: opportunity,
                   statement: statement %>
      </div>
    </div>
  </div>
</div>
