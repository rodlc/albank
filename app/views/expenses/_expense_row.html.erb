<% opportunity = expense.opportunities.first %>

<div class="expense-row">
  <!-- Mobile: Stack vertical -->
  <div class="d-md-none">
    <div class="d-flex align-items-center mb-2">
      <div class="expense-icon me-2">
        <%= category_emoji(expense.category) %>
      </div>

      <div class="flex-grow-1">
        <div class="expense-category fw-bold">
          <%= expense.category.name %>
        </div>
      </div>
    </div>

    <div class="text-muted small mb-2">
      <%= expense.label %>
      <% if expense.respond_to?(:grouped?) && expense.grouped? %>
        <span class="badge bg-secondary ms-1">√ó<%= expense.grouped_expenses.size %></span>
      <% end %>
    </div>

    <div class="d-flex justify-content-between align-items-center">
      <div>
        <span class="expense-amount fw-bold">
          <%= number_to_currency(expense.subtotal, unit: "‚Ç¨", precision: 2, separator: ",", delimiter: " ") %>
        </span>

        <% if opportunity&.opportunity? && opportunity.savings > 0 %>
          <span class="expense-savings text-primary ms-2">
            -<%= number_to_currency(opportunity.savings, unit: "‚Ç¨", precision: 0, separator: ",", delimiter: " ") %>
          </span>
        <% end %>
      </div>

      <div>
        <% if opportunity&.completed? %>
          <span class="btn btn-sm btn-outline-success disabled">üéâ Optimis√©</span>
        <% elsif opportunity&.contacted? %>
          <%= link_to statement_expense_opportunity_path(statement, expense, opportunity),
                      class: "btn btn-sm btn-outline-primary" do %>
            ‚úÖ Archiver
          <% end %>
        <% elsif opportunity&.danger? %>
          <%= link_to statement_expense_opportunity_path(statement, expense, opportunity),
                      class: "btn btn-sm btn-danger text-white" do %>
            üö® Alerter
          <% end %>
        <% elsif opportunity %>
          <%= link_to statement_expense_opportunity_path(statement, expense, opportunity),
                      class: "btn btn-sm btn-primary text-white" do %>
            ‚úâÔ∏è Contacter
          <% end %>
        <% else %>
          <span class="btn btn-sm btn-light disabled">‚òëÔ∏è OK</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Desktop: Fixed-width flexbox columns -->
  <div class="d-none d-md-flex expense-row-desktop align-items-center">
    <!-- Icon + Category (Fixed) -->
    <div class="expense-row-category">
      <div class="expense-icon">
        <%= category_emoji(expense.category) %>
      </div>
      <div class="expense-category">
        <%= expense.category.name %>
      </div>
    </div>

    <!-- Label (Flexible with truncation) -->
    <div class="expense-row-label">
      <span class="expense-label text-muted">
        <%= expense.label %>
        <% if expense.respond_to?(:grouped?) && expense.grouped? %>
          <span class="badge bg-secondary ms-1">√ó<%= expense.grouped_expenses.size %></span>
        <% end %>
      </span>
    </div>

    <!-- Amount + Savings (Fixed right) -->
    <div class="expense-row-amount">
      <div class="expense-amount">
        <%= number_to_currency(expense.subtotal, unit: "‚Ç¨", precision: 2, separator: ",", delimiter: " ") %>
      </div>

      <% if opportunity&.opportunity? && opportunity.savings > 0 %>
        <div class="expense-savings">
          -<%= number_to_currency(opportunity.savings, unit: "‚Ç¨", precision: 0, separator: ",", delimiter: " ") %>
        </div>
      <% end %>
    </div>

    <!-- Action Button (Fixed right) -->
    <div class="expense-row-action">
      <% if opportunity&.completed? %>
        <span class="btn btn-sm btn-outline-success disabled">üéâ Optimis√©</span>
      <% elsif opportunity&.contacted? %>
        <%= link_to statement_expense_opportunity_path(statement, expense, opportunity),
                    class: "btn btn-sm btn-outline-primary" do %>
          ‚úÖ Archiver
        <% end %>
      <% elsif opportunity&.danger? %>
        <%= link_to statement_expense_opportunity_path(statement, expense, opportunity),
                    class: "btn btn-sm btn-danger text-white" do %>
          üö® Alerter
        <% end %>
      <% elsif opportunity %>
        <%= link_to statement_expense_opportunity_path(statement, expense, opportunity),
                    class: "btn btn-sm btn-primary text-white" do %>
          ‚úâÔ∏è Contacter
        <% end %>
      <% else %>
        <span class="btn btn-sm btn-light disabled">‚òëÔ∏è OK</span>
      <% end %>
    </div>
  </div>
</div>
