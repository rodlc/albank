<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6 text-center">
      <!-- Header -->
      <h1 class="mb-3">Importez votre relevé bancaire</h1>
      <p class="text-muted mb-5">
        Déposez votre relevé PDF pour détecter les économies possibles sur vos abonnements et assurances.
      </p>

      <!-- Drop Zone -->
      <div class="file-upload-wrapper mb-4">
        <label for="file-input" class="upload-label upload-hero" id="dropZone">
          <div class="text-center">
            <img
              src="<%= image_path 'logo-cochon.svg' %>"
              alt="Choisir un fichier"
              title="Cliquer pour importer"
              class="upload-label-image mb-3"
              style="max-width: 250px; margin: 0 auto; display: block; cursor: pointer;"
            >
            <p class="text-muted">
              <i class="fas fa-cloud-upload-alt me-2"></i>
              Glissez-déposez votre relevé ou cliquez ici
            </p>
          </div>
        </label>

        <input
          id="file-input"
          type="file"
          accept="application/pdf,*"
          style="display: none;"
        >
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="d-none">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Importation en cours...</span>
        </div>
        <p class="text-muted mt-2">Analyse du relevé en cours...</p>
      </div>
    </div>
  </div>
</div>

<script>
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('file-input');
  const loadingState = document.getElementById('loading-state');

  // Click to upload
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      handleFiles(e.target.files);
    }
  });

  // Drag & Drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFiles(files);
    }
  });

  function handleFiles(files) {
    const file = files[0];
    console.log("Fichier déposé :", file.name, file.size, file.type);

    // Show loading state
    dropZone.classList.add('d-none');
    loadingState.classList.remove('d-none');

    // Simulate PDF import
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    fetch('<%= import_pdf_statements_path %>', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': csrfToken,
        'Accept': 'text/html'
      }
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        return response.text().then(html => {
          document.body.innerHTML = html;
        });
      }
    })
    .catch(error => {
      console.error('Erreur import:', error);
      alert('Erreur lors de l\'importation. Veuillez réessayer.');
      dropZone.classList.remove('d-none');
      loadingState.classList.add('d-none');
    });
  }
</script>

