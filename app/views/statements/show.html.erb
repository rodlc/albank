<div class="container mt-5">
  <div class="mb-4">
    <%= link_to statements_path, class: "text-decoration-none text-muted small fw-bold" do %>
      <span class="me-1">‚Üê</span> RETOUR AUX RELEV√âS
    <% end %>
  </div>

  <div class="d-flex justify-content-between align-items-end mb-5">
    <div>
      <h1 class="fw-bold mb-1">
        <span class="underline-cyan">
          Relev√© de <%= l(@statement.date, format: "%B %Y").capitalize %>
        </span>
      </h1>

      <p class="text-muted mb-0">Analyse d√©taill√©e des transactions</p>
    </div>

    <div class="text-end">
      <span class="d-block text-muted small text-uppercase fw-bold">
        Total D√©penses
      </span>

      <span class="fs-2 fw-bold">
        <%= number_to_currency(@expenses.sum(&:subtotal), unit: "‚Ç¨", precision: 0) %>
      </span>
    </div>
  </div>

  <!-- Summary Cards -->
  <% total_savings = @expenses.joins(:opportunities).sum { |e| e.opportunities.sum(&:savings) } %>

  <% if total_savings > 0 %>
    <div
      class="
        alert bg-coral-subtle d-flex align-items-center border-0 shadow-sm
        mb-5
      "
      role="alert"
    >
      <div class="fs-1 me-3">üïµÔ∏è</div>

      <div>
        <h4 class="alert-heading fw-bold mb-1 text-coral">
          Potentiel d'√©conomie d√©tect√© !
        </h4>

        <p class="mb-0">
          En optimisant vos contrats, vous pourriez √©conomiser
          <strong class="fs-5 text-coral"><%= number_to_currency(total_savings, unit: "‚Ç¨", precision: 0) %> / mois</strong>.
        </p>
      </div>
    </div>
  <% end %>

  <% if @expenses.any? %>
    <div class="card border shadow-sm">
      <div class="card-header bg-white py-3 border-bottom">
        <div class="row align-items-center text-muted small fw-bold text-uppercase">
          <div class="col-md-3">Cat√©gorie</div>
          <div class="col-md-3">Libell√©</div>
          <div class="col-md-3 text-end">Montant</div>
          <div class="col-md-3 text-end">Analyse</div>
        </div>
      </div>

      <div class="list-group list-group-flush">
        <% @expenses.each do |expense| %>
          <% category_emoji = case expense.category.name
               when /√©lectricit√©|gaz|√©nergie/i then "‚ö°"
               when /internet|box|fibre/i then "üì°"
               when /habitation|logement/i then "üè†"
               when /auto|voiture/i then "üöó"
               when /assurance/i then "üõ°Ô∏è"
               when /banque|frais/i then "üè¶"
               else "üìã"
             end %>

          <div class="list-group-item py-3 action-row">
            <div class="row align-items-center">
              <!-- Category -->
              <div class="col-md-3 d-flex align-items-center">
                <div
                  class="
                    rounded-3 bg-light d-flex align-items-center
                    justify-content-center me-3
                  "
                  style="width: 48px; height: 48px; font-size: 1.5rem;"
                >
                  <%= category_emoji %>
                </div>

                <div>
                  <h6 class="mb-0 fw-bold text-dark">
                    <%= expense.category.name %>
                  </h6>

                  <small class="text-muted">Pr√©l√®vement mensuel</small>
                </div>
              </div>

              <!-- Label -->
              <div class="col-md-3">
                <span class="text-muted small">
                  <%= expense.label %>
                </span>
              </div>

              <!-- Amount -->
              <div class="col-md-3 text-end">
                <span class="fw-bold text-dark">
                  <%= number_to_currency(expense.subtotal, unit: "‚Ç¨", precision: 2) %>
                </span>
              </div>

              <!-- Action -->
              <div class="col-md-3 text-end">
                <% if expense.opportunities.any? %>
                  <% opportunity = expense.opportunities.first %>
                  <% if opportunity.completed? %>
                    <div class="btn disabled border-0 text-success fw-medium px-3">
                      <span class="me-1">üéâ</span> Optimis√©
                    </div>
                  <% elsif opportunity.contacted? %>
                    <div class="btn disabled border-0 text-primary fw-medium px-3">
                      <span class="me-1">‚úÖ</span> Contact√©
                    </div>
                  <% else %>
                    <%= link_to statement_expense_opportunity_path(@statement, expense, opportunity), class: "btn btn-primary text-white fw-bold px-3" do %>
                      <span class="me-1">‚ö°</span> √âconomiser
                      <%= number_to_currency(opportunity.savings, unit: "‚Ç¨", precision: 0) %>
                    <% end %>
                  <% end %>
                <% else %>
                  <div class="btn disabled border-0 text-muted opacity-75 fw-medium px-3">
                    <span class="me-1">‚òëÔ∏è</span> Optimis√©
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <% if @statement.total.present? %>
          <% autres_depenses = @statement.total - @expenses.sum(&:subtotal) %>
          <% if autres_depenses > 0 %>
            <div class="list-group-item py-3 bg-light">
              <div class="row align-items-center">
                <!-- Category -->
                <div class="col-md-3 d-flex align-items-center">
                  <div
                    class="
                      rounded-3 bg-white d-flex align-items-center
                      justify-content-center me-3
                    "
                    style="width: 48px; height: 48px; font-size: 1.5rem;"
                  >
                    üìã
                  </div>

                  <div>
                    <h6 class="mb-0 fw-bold text-muted">
                      Autres d√©penses
                    </h6>

                    <small class="text-muted">Non cat√©goris√©</small>
                  </div>
                </div>

                <!-- Label -->
                <div class="col-md-3">
                  <span class="text-muted small fst-italic">
                    D√©penses non reconnues
                  </span>
                </div>

                <!-- Amount -->
                <div class="col-md-3 text-end">
                  <span class="fw-bold text-muted">
                    <%= number_to_currency(autres_depenses, unit: "‚Ç¨", precision: 2) %>
                  </span>
                </div>

                <!-- Action -->
                <div class="col-md-3 text-end">
                  <div class="btn disabled border-0 text-muted opacity-50 fw-medium px-3">
                    <span class="me-1">‚Äî</span> Aucune action
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="text-center py-5">
      <div class="mb-3 fs-1 opacity-50">
        üßæ
      </div>

      <p class="text-muted">Aucune d√©pense trouv√©e dans ce relev√©.</p>
    </div>
  <% end %>
</div>
